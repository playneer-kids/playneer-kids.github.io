<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»˜æ›¸è¼”åŠ©å™¨ | Playneer Kids</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        /* Back Home Button */
        .nav-home { align-self: flex-start; margin-bottom: 15px; max-width: 800px; width: 100%; margin-left: auto; margin-right: auto;}
        .btn-home { text-decoration: none; color: #4a5568; background: #e2e8f0; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-flex; align-items: center; transition: 0.2s; }
        .btn-home:hover { background: #cbd5e0; }

        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 800px; display: flex; flex-direction: column; }
        h2 { text-align: center; color: #2d3748; margin-bottom: 20px; font-weight: 800; letter-spacing: 1px; margin-top: 0; }
        
        /* å»£å‘Šå€å¡Š */
        .ad-container { width: 100%; min-height: 100px; background-color: #edf2f7; border: 1px dashed #cbd5e0; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: #718096; font-size: 14px; overflow: hidden; }

        .section-box { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .tips { font-size: 13px; color: #718096; background: #ebf8ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #4299e1; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; font-size: 14px; }
        
        textarea { width: 100%; height: 120px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 8px; font-size: 18px; resize: vertical; transition: all 0.3s; font-family: inherit; line-height: 1.5; }
        textarea:focus { border-color: #4299e1; outline: none; }
        
        /* æ ¸å¿ƒé®è”½æ¨£å¼ */
        body.masked-mode #text-input,
        body.masked-mode #current-word-display, 
        body.masked-mode #sentence-preview,
        body.masked-mode #pronunciation-display { filter: blur(12px); opacity: 0.5; user-select: none; pointer-events: none; }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
        .action-left { display: flex; gap: 10px; align-items: center; }
        .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-upload { background: #4a5568; color: white; }
        .btn-toggle-eye { background: #ed8936; color: white; }
        .btn-toggle-eye:hover { background: #dd6b20; }

        select, input[type="range"] { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: 1px solid #cbd5e0; border-radius: 6px; }

        /* é¡¯ç¤ºå€ */
        .dictation-display { background-color: #ebf8ff; border: 3px dashed #4299e1; color: #2c5282; padding: 30px 20px; border-radius: 15px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .current-word { font-size: 60px; font-weight: bold; color: #2b6cb0; line-height: 1.2; margin-bottom: 5px; text-align: center; }
        .word-pronunciation { font-size: 14px; color: #fff; background: #4a5568; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; }
        .full-sentence-preview { font-size: 16px; color: #718096; text-align: center; margin-top: 15px; min-height: 24px; }

        .controls-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .control-item { flex: 1; min-width: 140px; }

        .buttons { display: flex; gap: 10px; margin-top: 20px; }
        button.main-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #btn-play { background: #48bb78; } #btn-pause { background: #ecc94b; color: #4a5568; } #btn-stop { background: #f56565; }
        .nav-btn { background: #cbd5e0; color: #4a5568; max-width: 60px; }
        button:active { transform: scale(0.98); } button:disabled { background: #edf2f7; color: #cbd5e0; cursor: not-allowed; box-shadow: none; }

        .status { margin-top: 10px; text-align: right; font-size: 13px; color: #718096; }
        
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #edf2f7; font-size: 12px; color: #a0aec0; text-align: center; line-height: 1.6; }
        .footer a { color: #718096; text-decoration: underline; }
    </style>
	<style>
		/* ç¦æ­¢é¸å–æ–‡å­— */
		body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
	</style>
	<script>
		// ç¦æ­¢å³éµé¸å–®
		document.addEventListener('contextmenu', event => event.preventDefault());
		// ç¦æ­¢ F12 å’Œä¸€äº›å¿«æ·éµ (åƒ…ä½œç°¡å–®é˜²è­·)
		document.onkeydown = function(e) {
			if(event.keyCode == 123) { return false; } // F12
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } // Ctrl+Shift+C
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } // Ctrl+Shift+J
			if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
		}
	</script>
</head>
<body>

<div class="nav-home">
    <a href="../../index.html" class="btn-home">â¬… å›é¦–é  (Back to Home)</a>
</div>

<div class="container">
    <h2>ğŸ“ é»˜æ›¸è¼”åŠ©å™¨</h2>
	<h2 style="color:red;">ğŸ“ é»˜æ›¸ç¥å™¨ v99 (è©æ¬ºç‰ˆ)</h2>

    <!--<div class="ad-container">
    
    </div>-->

    <div class="section-box">
        <label>é»˜æ›¸å…§å®¹è¼¸å…¥ï¼š</label>
        <div class="tips">
            ğŸ’¡ <b>Live åµæ¸¬ï¼š</b> è‡ªå‹•åˆ†è¾¨ [adj] è³´-v (ç¾å ´) / [v] åŠ›-v (ä½)ã€‚ç¯„ä¾‹ï¼šLive[adj] musicã€‚<br>
        </div>
        <textarea id="text-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥è‹±æ–‡æˆ–ä¸­æ–‡å…§å®¹...">I like live[adj] music.
I live[v] in Hong Kong.</textarea>
        
        <div class="action-bar">
            <div class="action-left">
                <input id="file-upload" type="file" accept=".txt" style="display:none;"/>
                <button onclick="document.getElementById('file-upload').click()" class="btn-sm btn-upload">ğŸ“‚ ä¸Šå‚³æª”æ¡ˆ</button>
                <span id="file-name" style="font-size:12px; color:#888;"></span>
            </div>
            <button id="btn-toggle-view" class="btn-sm btn-toggle-eye">ğŸ‘ï¸ é®è”½å…§å®¹ (é»˜æ›¸æ¨¡å¼)</button>
        </div>
    </div>

    <div class="section-box">
        <div class="controls-row">
            <div class="control-item">
                <label>èªè¨€</label>
                <select id="lang-select">
                    <option value="en-GB">è‹±èª (UK/Commonwealth)</option>
                    <option value="zh-HK">ç²µèª (Cantonese)</option>
                    <option value="zh-CN">æ™®é€šè©± (Mandarin)</option>
                </select>
            </div>
            <div class="control-item">
                <label>è®€å­—èªé€Ÿ: <span id="rate-value">0.8</span>x</label>
                <input type="range" id="rate-range" min="0.1" max="1.5" step="0.1" value="0.8">
            </div>
            <div class="control-item">
                <label style="color:#3182ce;">å­—èˆ‡å­—åœé “: <span id="interval-value">1.5</span>ç§’</label>
                <input type="range" id="interval-range" min="0" max="5" step="0.5" value="1.5">
            </div>
        </div>
        <div style="margin-top:15px; display:flex; gap:20px; align-items:center;">
             <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="auto-play-check"> è‡ªå‹•è®€ä¸‹ä¸€å¥
             </label>
             <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="dictation-mode" checked> é»˜æ›¸æ¨¡å¼ (é€å­—è®€)
             </label>
        </div>
    </div>

    <div class="dictation-display">
        <div class="word-pronunciation" id="pronunciation-display" style="display:none;"></div>
        <div class="current-word" id="current-word-display">...</div>
        <div class="full-sentence-preview" id="sentence-preview">æº–å‚™å°±ç·’</div>
    </div>
    <div style="text-align:center; color:#888; font-size:12px;" id="progress-indicator">ç¬¬ 0 / 0 å¥</div>

    <div class="buttons">
        <button id="btn-prev" class="main-btn nav-btn" disabled>â®</button>
        <button id="btn-play" class="main-btn">â–¶ é–‹å§‹</button>
        <button id="btn-pause" class="main-btn" style="display:none;">â¸ æš«åœ</button>
        <button id="btn-stop" class="main-btn" disabled>â¹ åœæ­¢</button>
        <button id="btn-next" class="main-btn nav-btn" disabled>â­</button>
    </div>
    
    <div class="status" id="status-msg"></div>

    <div class="footer">
        <button onclick="checkVoices()" style="background:#718096; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px; margin-bottom:10px;">ğŸ› ï¸ æª¢æ¸¬èªéŸ³åº« (Debug)</button>
        <p>ğŸ”’ <strong>éš±ç§æ¬Šè²æ˜ï¼š</strong> æœ¬ç³»çµ±æ‰€æœ‰æ–‡å­—è™•ç†èˆ‡é‹ç®—å‡åœ¨æ‚¨çš„ç€è¦½å™¨å…§å®Œæˆ (Client-side processing)ã€‚æˆ‘å€‘ä¸æœƒæ”¶é›†æ‚¨çš„ä»»ä½•è³‡æ–™ã€‚</p>
        <p><a href="privacy.html">æŸ¥çœ‹å®Œæ•´éš±ç§æ¬Šæ”¿ç­–</a> | Â© 2026 Playneer Kids</p>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    const textInput = document.getElementById('text-input');
    const btnToggleView = document.getElementById('btn-toggle-view');
    const langSelect = document.getElementById('lang-select');
    const rateRange = document.getElementById('rate-range');
    const rateValue = document.getElementById('rate-value');
    const intervalRange = document.getElementById('interval-range');
    const intervalValue = document.getElementById('interval-value');
    const autoPlayCheck = document.getElementById('auto-play-check');
    const dictationModeCheck = document.getElementById('dictation-mode');
    
    const currentWordDisplay = document.getElementById('current-word-display');
    const pronunciationDisplay = document.getElementById('pronunciation-display');
    const sentencePreview = document.getElementById('sentence-preview');
    const progressIndicator = document.getElementById('progress-indicator');
    const statusMsg = document.getElementById('status-msg');
    
    const btnPlay = document.getElementById('btn-play');
    const btnPause = document.getElementById('btn-pause');
    const btnStop = document.getElementById('btn-stop');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    let sentences = []; let sentenceIndex = 0; let wordQueue = []; let wordIndex = 0;
    let isPlaying = false; let isPaused = false; let timerId = null; let voices = [];
    let isMasked = false;
    
    let currentUtterance = null; // âœ¨ æ–°å¢é€™ä¸€è¡Œ (ç”¨ä¾†é˜²æ­¢æ‰‹æ©Ÿå›æ”¶èªéŸ³ç‰©ä»¶)
	// âœ¨ æ–°å¢é€™ä¸€æ®µï¼šiOS èªéŸ³å¼•æ“å¼·å¿ƒé‡ âœ¨
    let resumeInterval = null;
	
	function startHeartbeat() {
        if (resumeInterval) clearInterval(resumeInterval);
        resumeInterval = setInterval(() => {
            if (isPlaying && !isPaused) {
                synth.resume(); // æ¯ 200ms æˆ³ä¸€ä¸‹å¼•æ“ï¼Œå¼·è¿«å®ƒä¿æŒæ¸…é†’
            }
        }, 200);
    }

    function stopHeartbeat() {
        if (resumeInterval) clearInterval(resumeInterval);
        resumeInterval = null;
    }
    // ------------------------------------

    function init() { populateVoices(); if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices; }
    function populateVoices() { voices = synth.getVoices(); }
    init();

    rateRange.addEventListener('input', () => rateValue.textContent = rateRange.value);
    intervalRange.addEventListener('input', () => intervalValue.textContent = intervalRange.value);
    textInput.addEventListener('input', () => { if(!isPlaying && !isPaused) resetPlayer(); });
    
    btnToggleView.addEventListener('click', () => {
        isMasked = !isMasked;
        if (isMasked) {
            document.body.classList.add('masked-mode');
            btnToggleView.textContent = "ğŸ‘ï¸ é¡¯ç¤ºå…§å®¹"; btnToggleView.style.background = "#2b6cb0";
        } else {
            document.body.classList.remove('masked-mode');
            btnToggleView.textContent = "ğŸ‘ï¸ é®è”½å…§å®¹ (é»˜æ›¸æ¨¡å¼)"; btnToggleView.style.background = "#ed8936";
        }
    });

    document.getElementById('file-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('file-name').textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => { textInput.value = e.target.result; resetPlayer(); statusMsg.textContent = "æª”æ¡ˆå·²è¼‰å…¥"; };
        reader.readAsText(file);
    });

    function splitTextIntoSentences(text) {
        // ä¿®æ”¹èªªæ˜ï¼š
        // èˆŠé‚è¼¯ï¼šåªæŠ“æ¨™é»ç¬¦è™Ÿ -> [.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]*
        // æ–°é‚è¼¯ï¼šæŠ“æ¨™é»ç¬¦è™Ÿ + é¸æ“‡æ€§æŠ“å–å¾Œé¢çš„æ”¶å¼•è™Ÿ -> (?:[.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+[â€â€™ã€ï¼‰\]]*)?
        
        // åŒ…å«å¸¸è¦‹çš„æ”¶å°¾ç¬¦è™Ÿï¼šâ€ (å³é›™å¼•è™Ÿ), â€™ (å³å–®å¼•è™Ÿ), ã€ (ä¸­æ–‡å³å¼•è™Ÿ), ï¼‰ (å…¨å½¢å³æ‹¬è™Ÿ), ] (åŠå½¢å³æ‹¬è™Ÿ)
        const regex = /[^.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+(?:[.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+[â€â€™ã€ï¼‰\]]*)?|.+/g;
        
        return (text.match(regex) || []).map(s => s.trim()).filter(s => s.length > 0);
    }

    function generateDictationQueue(text, lang) {
        let queue = [];
        
        // 1. è‹±æ–‡è™•ç†é‚è¼¯ (ä¿æŒä¸è®Š)
        if (lang === 'en-GB') {
            const rawTokens = text.match(/[\w']+(\[[a-z]+\])?|[^\w\s]/gi) || [];
            const punctMap = { '.': 'full stop', ',': 'comma', '?': 'question mark', '!': 'exclamation mark', ':': 'colon', ';': 'semi-colon', '(': 'open bracket', ')': 'close bracket', '"': 'quote' };
            for (let i = 0; i < rawTokens.length; i++) {
                let token = rawTokens[i], cleanWord = token, speakWord = token, manualTag = null;
                if (token.includes('[')) {
                    if (token.toLowerCase().includes('[adj]')) manualTag = 'adj';
                    else if (token.toLowerCase().includes('[v]')) manualTag = 'v';
                    cleanWord = token.replace(/\[.*?\]/g, ''); speakWord = cleanWord;
                }
                if (punctMap[cleanWord]) queue.push({ display: cleanWord, speak: punctMap[cleanWord], isPunct: true });
                else {
                    if (cleanWord.toLowerCase() === 'live') {
                        if (manualTag === 'adj') speakWord = "lye-v"; else if (manualTag === 'v') speakWord = "liv"; else speakWord = detectLivePronunciation(i, rawTokens);
                    }
                    queue.push({ display: cleanWord, speak: speakWord, isPunct: false });
                }
            }
        } 
        // 2. ä¸­æ–‡è™•ç†é‚è¼¯ (é€™è£¡åŠ å…¥äº†å…’åŒ–éŸ³åˆ¤æ–·)
        else {
            //const punctMap = { 'ï¼Œ': 'é€—è™Ÿ', 'ã€‚': 'å¥è™Ÿ', 'ã€': 'é “è™Ÿ', 'ï¼Ÿ': 'å•è™Ÿ', 'ï¼': 'æ„Ÿå˜†è™Ÿ', 'ï¼š': 'å†’è™Ÿ', 'ï¼›': 'åˆ†è™Ÿ', 'ã€Œ': 'é–‹å¼•è™Ÿ', 'ã€': 'æ”¶å¼•è™Ÿ', 'ï¼ˆ': 'æ‹¬è™Ÿ', 'ï¼‰': 'æ‹¬è™Ÿå®Œ', ',': 'é€—è™Ÿ', '.': 'å¥è™Ÿ', '?': 'å•è™Ÿ', '!': 'æ„Ÿå˜†è™Ÿ' };
            const punctMap = { 'ï¼Œ': 'é€—è™Ÿ', 'ã€‚': 'å¥è™Ÿ', 'ã€': 'é “è™Ÿ', 'ï¼Ÿ': 'å•è™Ÿ', 'ï¼': 'æ„Ÿå˜†è™Ÿ', 'ï¼š': 'å†’è™Ÿ', 'ï¼›': 'åˆ†è™Ÿ', 'ã€Œ': 'é–‹å¼•è™Ÿ', 'ã€': 'é—œå¼•è™Ÿ', 'ï¼ˆ': 'é–‹æ‹¬è™Ÿ', 'ï¼‰': 'é—œæ‹¬è™Ÿ', ',': 'é€—è™Ÿ', '.': 'å¥è™Ÿ', '?': 'å•è™Ÿ', '!': 'æ„Ÿå˜†è™Ÿ' };

            // æ”¹ç”¨ for è¿´åœˆï¼Œä»¥ä¾¿æ§åˆ¶ç´¢å¼• (i)
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                let nextChar = text[i+1]; // å·çœ‹ä¸‹ä¸€å€‹å­—

                // è·³éç‰¹æ®Šçš„æ¨™è¨˜ç¬¦è™Ÿ (ä¿æŒåŸé‚è¼¯)
                if (['[', ']', 'a', 'd', 'j', 'v'].includes(char) && text.includes('[')) continue; 
                if (char.trim() === '') continue;

                // è™•ç†æ¨™é»ç¬¦è™Ÿ
                if (punctMap[char]) {
                    queue.push({ display: char, speak: punctMap[char], isPunct: true });
                }
                // --- âœ¨ æ–°å¢ï¼šå…’åŒ–éŸ³è™•ç†é‚è¼¯ âœ¨ ---
                // å¦‚æœç›®å‰ä¸æ˜¯æ¨™é»ï¼Œä¸”ä¸‹ä¸€å€‹å­—æ˜¯ã€Œå…’ã€ï¼Œä¸”èªè¨€æ˜¯æ™®é€šè©±(zh-CN)
                else if (nextChar === 'å…’' && lang === 'zh-CN' && !punctMap[nextChar]) {
                    // æŠŠ "é€™" å’Œ "å…’" åˆä½µæˆ "é€™å…’"
                    let combined = char + nextChar;
                    queue.push({ display: combined, speak: combined, isPunct: false });
                    i++; // é‡è¦ï¼å› ç‚ºå·²ç¶“æŠŠã€Œå…’ã€ç”¨æ‰äº†ï¼Œæ‰€ä»¥è·³éä¸‹ä¸€æ¬¡è¿´åœˆ
                }
                // ----------------------------------
                else if (char === 'ç©' && lang === 'zh-HK') {
                    queue.push({ display: 'ç©', speak: 'æ›', isPunct: false });
                }
                else {
                    queue.push({ display: char, speak: char, isPunct: false });
                }
            }
        }
        return queue;
    }
	
    function detectLivePronunciation(idx, tokens) {
        let pronunciation = "liv"; 
        const clean = (t) => t ? t.replace(/\[.*?\]/g, '').toLowerCase() : '';
        const prev = idx > 0 ? clean(tokens[idx - 1]) : '';
        const next = idx < tokens.length - 1 ? clean(tokens[idx + 1]) : '';
        const adjK = ['music', 'show', 'band', 'stream', 'broadcast', 'concert', 'performance', 'video', 'radio', 'tv', 'action'];
        if (adjK.includes(next) || prev === 'real' || ['facebook', 'youtube', 'instagram'].includes(prev)) return "lye-v";
        if (['in', 'at', 'on', 'with', 'by'].includes(next) || ['i', 'we', 'you', 'they'].includes(prev)) return "liv";
        return pronunciation; 
    }

    function startSentence() {
        if (sentenceIndex >= sentences.length) { statusMsg.textContent = "å…¨éƒ¨å®Œæˆ"; resetPlayer(); return; }
        const raw = sentences[sentenceIndex];
        const lang = langSelect.value;
        sentencePreview.textContent = raw.replace(/\[.*?\]/g, '');
        progressIndicator.textContent = `ç¬¬ ${sentenceIndex + 1} / ${sentences.length} å¥`;
        wordQueue = generateDictationQueue(raw, lang);
        wordIndex = 0;
        if (dictationModeCheck.checked) playNextWord();
        else { let fullSpeak = wordQueue.map(w => w.speak).join(' '); playWholeSentence(fullSpeak, sentencePreview.textContent); }
    }

    // ç”¨ä¾†å­˜æ”¾èªéŸ³ç‰©ä»¶ï¼Œé˜²æ­¢è¢«ç€è¦½å™¨å›æ”¶
    let utteranceStorage = []; 
	let watchdogTimer = null; //  æ–°å¢ï¼šçœ‹é–€ç‹—è¨ˆæ™‚å™¨
	
	//  æ–°å¢ï¼šæ¸…é™¤çœ‹é–€ç‹—çš„å‡½æ•¸
    function clearWatchdog() {
        if (watchdogTimer) {
            clearTimeout(watchdogTimer);
            watchdogTimer = null;
        }
    }

    function playNextWord() {
        // 1. åŸºæœ¬æª¢æŸ¥
        if (!isPlaying) return;
        if (wordIndex >= wordQueue.length) { finishSentence(); return; }
        
        // 2. é¡¯ç¤ºæ–‡å­—
        const item = wordQueue[wordIndex];
        currentWordDisplay.textContent = item.display;
        
        if (item.isPunct) { 
            pronunciationDisplay.textContent = `è®€ä½œ: ${item.speak}`; 
            pronunciationDisplay.style.display = 'block'; 
        } else if (item.display.toLowerCase() === 'live' && item.speak === 'lye-v') { 
            pronunciationDisplay.textContent = `ç™¼éŸ³: è³´-v (å½¢å®¹è©)`; 
            pronunciationDisplay.style.display = 'block'; 
        } else { 
            pronunciationDisplay.style.display = 'none'; 
        }

        // 3. å»ºç«‹èªéŸ³ç‰©ä»¶
        let u = new SpeechSynthesisUtterance(item.speak);
        setupVoice(u);
        
        // æ”¾å…¥åƒåœ¾æ¡¶é˜²æ­¢å›æ”¶
        utteranceStorage.push(u);

        // âœ¨ ä¿è­·æ©Ÿåˆ¶ 1ï¼šå–®æ¬¡åŸ·è¡Œé– âœ¨
        // ç¢ºä¿é€™å€‹å­—çš„çµæŸé‚è¼¯åªæœƒè·‘ä¸€æ¬¡ï¼Œä¸æœƒå› ç‚º watchdog å’Œ onend åŒæ™‚è§¸ç™¼è€Œè·³å…©æ¬¡
        let hasFinished = false;

        const handleEnd = () => {
            if (hasFinished) return; // å¦‚æœå·²ç¶“è™•ç†éï¼Œå°±ç›´æ¥é€€å‡º
            hasFinished = true;

            clearWatchdog();
            
            // å¾åƒåœ¾æ¡¶ç§»é™¤
            utteranceStorage = utteranceStorage.filter(ut => ut !== u);

            if (!isPlaying) return; 

            statusMsg.textContent = `...`; 
            
            // âœ¨ ä¿è­·æ©Ÿåˆ¶ 2ï¼šå¼·åˆ¶æœ€ä½å®‰å…¨é–“éš” (é—œéµï¼) âœ¨
            // iOS èªéŸ³å¼•æ“åˆ‡æ›éœ€è¦æ™‚é–“ï¼Œä½æ–¼ 200ms (0.2ç§’) æœƒæœ‰æ¥µé«˜æ©Ÿç‡æ‰å­—
            // æ‰€ä»¥æˆ‘å€‘å¼·åˆ¶è¨­å®šï¼šæœ€å°‘ 200msï¼Œä¸ç®¡ä½¿ç”¨è€…æ‹‰å¾—å¤šå¿«
            let userInterval = parseFloat(intervalRange.value) * 1000;
            let safeDelay = Math.max(userInterval, 250); // æ”¹ç‚º 250ms æ›´ä¿éšª

            timerId = setTimeout(() => { 
                // âœ¨ ä¿è­·æ©Ÿåˆ¶ 3ï¼šç™¼éŸ³å‰æ¸…å ´ âœ¨
                // ç¶“éäº† 250ms çš„ä¼‘æ¯ï¼Œä¸Šä¸€å¥è‚¯å®šè¬›å®Œäº†ï¼Œé€™æ™‚å€™ cancel ç¢ºä¿é€šé“ä¹¾æ·¨
                synth.cancel();
                
                wordIndex++; 
                playNextWord(); 
            }, safeDelay); 
        };

        // ç¶å®šäº‹ä»¶
        u.onend = handleEnd;
        u.onerror = (e) => { 
            console.error("Speech Error:", e);
            handleEnd(); 
        }; 

        // çœ‹é–€ç‹— (Watchdog)
        clearWatchdog();
        // çµ¦äºˆå……è¶³çš„å¯¬é™æ™‚é–“
        let estimatedTime = (item.speak.length * 500) + 2000; 
        if (estimatedTime < 3000) estimatedTime = 3000; 

        watchdogTimer = setTimeout(() => {
            console.warn("âš ï¸ çœ‹é–€ç‹—å¼·åˆ¶è·³ä¸‹ä¸€å­—");
            handleEnd();
        }, estimatedTime);
        
        // é€™è£¡ä¸éœ€è¦ cancelï¼Œå› ç‚ºæˆ‘å€‘åœ¨ setTimeout è£¡åšéæ¸…å ´äº†
        synth.speak(u);
    }

    function playWholeSentence(speakText, displayText) {
        currentWordDisplay.textContent = displayText; 
        currentWordDisplay.style.fontSize = "24px"; 
        pronunciationDisplay.style.display = 'none';
        
        // åŒæ¨£ä½¿ç”¨å…¨åŸŸè®Šæ•¸
        currentUtterance = new SpeechSynthesisUtterance(speakText); 
        setupVoice(currentUtterance);
        
        currentUtterance.onend = () => finishSentence(); 
        
        synth.cancel(); // æ’­æ”¾å‰å…ˆæ¸…é™¤èˆŠçš„
        synth.speak(currentUtterance);
    }

    // ä¿®æ”¹ finishSentence (æ•´å¥è®€å®Œæ™‚)
    function finishSentence() {
        if (autoPlayCheck.checked && isPlaying) { 
            // å¦‚æœé‚„æœ‰ä¸‹ä¸€å¥ï¼Œä¿æŒå¼·å¿ƒé‡é–‹å•Ÿ
            statusMsg.textContent = "æº–å‚™ä¸‹ä¸€å¥..."; 
            currentWordDisplay.style.fontSize = "60px"; 
            timerId = setTimeout(() => { sentenceIndex++; startSentence(); }, 1000); 
        } else { 
            isPlaying = false; 
            stopHeartbeat(); // âœ¨ å…¨éƒ¨è®€å®Œï¼Œé—œé–‰å¼·å¿ƒé‡
            wordIndex = 0; 
            statusMsg.textContent = "æœ¬å¥çµæŸ"; 
            currentWordDisplay.style.fontSize = "60px"; 
            updateUI(); 
        }
    }

    function setupVoice(u) {
        u.rate = parseFloat(rateRange.value);
        let availableVoices = synth.getVoices();
        let targetLang = langSelect.value; 
        let selectedVoice = null;

        // --- æ™®é€šè©± (Mandarin) ---
        if (targetLang === 'zh-CN') {
            // 1. åš´æ ¼é–å®šå©·å©·
            selectedVoice = availableVoices.find(v => v.name === 'å©·å©·' || v.name === 'Ting-Ting') ||
                            availableVoices.find(v => v.name === 'Bin-Bin' || v.name === 'å½¬å½¬');
            
            // 2. æ‰¾ä¸åˆ°æ‰æ‰¾é€šç”¨
            if (!selectedVoice) selectedVoice = availableVoices.find(v => v.lang === 'zh-CN');
        } 
        // --- å»£æ±è©± (Cantonese) ---
        else if (targetLang === 'zh-HK') {
            selectedVoice = availableVoices.find(v => v.name === 'Sin-ji' || v.name === 'ä»™èŠ') ||
                            availableVoices.find(v => v.lang === 'zh-HK');
        } 
        // --- è‹±èª (English) ---
        else if (targetLang === 'en-GB') {
            selectedVoice = availableVoices.find(v => v.name === 'Daniel') ||
                            availableVoices.find(v => v.lang === 'en-GB');
        }

        // --- æ‡‰ç”¨è¨­å®š ---
        if (selectedVoice) {
            u.voice = selectedVoice;
            
            // ğŸš¨ å€Ÿæ®¼ä¸Šå¸‚æˆ°è¡“ (The Japan Strategy) ğŸš¨
            // é¦™æ¸¯ iOS å° 'zh' é–‹é ­çš„èªè¨€æœ‰æ¥µå¼·çš„æ§åˆ¶æ¬²ï¼Œæœƒå¼·åˆ¶è½‰å»£æ±è©±ã€‚
            // æˆ‘å€‘æŠŠæ™®é€šè©±å½è£æˆ 'ja-JP' (æ—¥æ–‡)ã€‚
            // å› ç‚ºæ—¥æ–‡ä¹Ÿæœ‰æ¼¢å­—ï¼Œç³»çµ±ä¸æœƒå ±éŒ¯ï¼Œä¸”ä¸æœƒè§¸ç™¼ã€Œé¦™æ¸¯åœ°å€é–å®šã€ã€‚
            // å©·å©· (æ™®é€šè©±å¼•æ“) æ‹¿åˆ°å¾Œï¼Œæœƒç…§æ¨£ç”¨æ™®é€šè©±å”¸å‡ºé€™äº›å­—ã€‚
            if (targetLang === 'zh-CN') {
                u.lang = 'ja-JP'; 
            } else {
                u.lang = selectedVoice.lang;
            }
        } else {
            // æ²’æŠ“åˆ°è²éŸ³æ™‚çš„å¾Œå‚™
            u.lang = targetLang === 'zh-CN' ? 'ja-JP' : targetLang;
        }

        // Debug é¡¯ç¤º (ğŸ‡¯ğŸ‡µ æ—¥æœ¬åœ‹æ——ç‰ˆ)
        let debugName = selectedVoice ? selectedVoice.name : "ç³»çµ±é è¨­";
        if (statusMsg) statusMsg.textContent = `ğŸ‡¯ğŸ‡µ ${debugName} [${u.lang}] ğŸ‡¯ğŸ‡µ`; 
        console.log(`[Debug] ç›®æ¨™: ${targetLang}, æŠ“åˆ°: ${debugName}, å½è£èªè¨€: ${u.lang}`);
    }
	
    // ä¿®æ”¹ btnPlay çš„ç›£è½å™¨
    btnPlay.addEventListener('click', () => {
        if (sentences.length === 0) { 
            const txt = textInput.value.trim(); 
            if (!txt) { alert("è«‹è¼¸å…¥æ–‡å­—"); return; } 
            sentences = splitTextIntoSentences(txt); 
        }
        isPlaying = true; isPaused = false;
        
        startHeartbeat(); // âœ¨ å•Ÿå‹•å¼·å¿ƒé‡ï¼
        
        if (wordIndex === 0 && sentenceIndex < sentences.length) startSentence(); 
        else if (wordQueue.length > 0) playNextWord(); 
        else startSentence();
        
        updateUI();
    });

    // ä¿®æ”¹ btnPause
    btnPause.addEventListener('click', () => { 
        isPlaying = false; isPaused = true; 
        synth.cancel(); 
        clearTimeout(timerId); 
        stopHeartbeat(); 
        clearWatchdog(); //  åŠ å…¥é€™è¡Œ
        statusMsg.textContent = "å·²æš«åœ"; 
        updateUI(); 
    });
	
	
	btnStop.addEventListener('click', resetPlayer);
    btnPrev.addEventListener('click', () => { if(sentenceIndex>0){ sentenceIndex--; resetForNavigation();} });
    btnNext.addEventListener('click', () => { if(sentenceIndex<sentences.length-1){ sentenceIndex++; resetForNavigation();} });
    
    function resetForNavigation() { isPlaying=false; isPaused=false; synth.cancel(); clearTimeout(timerId); wordIndex=0; wordQueue=[]; 
        sentencePreview.textContent = sentences[sentenceIndex].replace(/\[.*?\]/g, ''); currentWordDisplay.textContent = "..."; progressIndicator.textContent = `ç¬¬ ${sentenceIndex + 1} / ${sentences.length} å¥`; updateUI(); }
    
    // ä¿®æ”¹ resetPlayer
    function resetPlayer() { 
        isPlaying=false; isPaused=false; 
        synth.cancel(); 
        clearTimeout(timerId); 
        stopHeartbeat();
        clearWatchdog(); // âœ¨ åŠ å…¥é€™è¡Œ
        
        // ... (å¾Œé¢ä¿æŒä¸è®Š)
        sentenceIndex=0; wordIndex=0; wordQueue=[]; sentences=[]; currentWordDisplay.textContent="..."; sentencePreview.textContent="æº–å‚™å°±ç·’"; progressIndicator.textContent="ç¬¬ 0 / 0 å¥"; statusMsg.textContent="å·²é‡ç½®"; updateUI(); 
    }
	
    function updateUI() {
        if (isPlaying) { btnPlay.style.display = 'none'; btnPause.style.display = 'inline-block'; btnStop.disabled = false; textInput.disabled = true; dictationModeCheck.disabled = true; } 
        else { btnPlay.textContent = (isPaused) ? "â–¶ ç¹¼çºŒ" : ((sentences.length > 0 && wordIndex === 0) ? "â–¶ æœ—è®€æ­¤å¥" : "â–¶ é–‹å§‹"); btnPlay.style.display = 'inline-block'; btnPause.style.display = 'none'; btnStop.disabled = !(sentences.length > 0 || textInput.value.trim().length > 0); if (sentences.length > 0) { btnPrev.disabled = (sentenceIndex===0); btnNext.disabled = (sentenceIndex>=sentences.length-1); } else { btnPrev.disabled=true; btnNext.disabled=true; } textInput.disabled = false; dictationModeCheck.disabled = false; }
    }
	
	// âœ¨ æ–°å¢é€™å€‹æª¢æ¸¬å‡½æ•¸ âœ¨
    function checkVoices() {
        const voices = window.speechSynthesis.getVoices();
        if (voices.length === 0) {
            alert("âš ï¸ ç€è¦½å™¨é‚„æ²’è¼‰å…¥èªéŸ³åŒ…ï¼è«‹è©¦è‘—é‡æ–°æ•´ç†ï¼Œæˆ–éš¨ä¾¿æŒ‰ä¸€ä¸‹æ’­æ”¾éµå¾Œå†è©¦ã€‚");
            return;
        }
        
        // ç¯©é¸å‡ºä¸­æ–‡å’Œè‹±æ–‡çš„è²éŸ³å°±å¥½ï¼Œä¸ç„¶åˆ—è¡¨å¤ªé•·
        const list = voices
            .filter(v => v.lang.includes('zh') || v.lang.includes('en'))
            .map(v => `[${v.lang}] ${v.name}`)
            .join('\n');
            
        alert("ğŸ” åµæ¸¬åˆ°çš„èªéŸ³åˆ—è¡¨ï¼š\n\n" + list);
    }
</script>
<script src="https://pl28580935.effectivegatecpm.com/28/a8/d2/28a8d2218e740f258f34f4ddc118c6d1.js"></script>
</body>
</html>