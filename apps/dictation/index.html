<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»˜æ›¸ç¥å™¨ | Playneer Kids</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4018994426619685" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        /* Back Home Button */
        .nav-home { align-self: flex-start; margin-bottom: 15px; max-width: 800px; width: 100%; margin-left: auto; margin-right: auto;}
        .btn-home { text-decoration: none; color: #4a5568; background: #e2e8f0; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-flex; align-items: center; transition: 0.2s; }
        .btn-home:hover { background: #cbd5e0; }

        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 800px; display: flex; flex-direction: column; }
        h2 { text-align: center; color: #2d3748; margin-bottom: 20px; font-weight: 800; letter-spacing: 1px; margin-top: 0; }
        
        /* å»£å‘Šå€å¡Š */
        .ad-container { width: 100%; min-height: 100px; background-color: #edf2f7; border: 1px dashed #cbd5e0; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: #718096; font-size: 14px; overflow: hidden; }

        .section-box { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .tips { font-size: 13px; color: #718096; background: #ebf8ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #4299e1; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; font-size: 14px; }
        
        textarea { width: 100%; height: 120px; padding: 12px; border: 2px solid #cbd5e0; border-radius: 8px; font-size: 18px; resize: vertical; transition: all 0.3s; font-family: inherit; line-height: 1.5; }
        textarea:focus { border-color: #4299e1; outline: none; }
        
        /* æ ¸å¿ƒé®è”½æ¨£å¼ */
        body.masked-mode #text-input,
        body.masked-mode #current-word-display, 
        body.masked-mode #sentence-preview,
        body.masked-mode #pronunciation-display { filter: blur(12px); opacity: 0.5; user-select: none; pointer-events: none; }

        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px; }
        .action-left { display: flex; gap: 10px; align-items: center; }
        .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-upload { background: #4a5568; color: white; }
        .btn-toggle-eye { background: #ed8936; color: white; }
        .btn-toggle-eye:hover { background: #dd6b20; }

        select, input[type="range"] { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: 1px solid #cbd5e0; border-radius: 6px; }

        /* é¡¯ç¤ºå€ */
        .dictation-display { background-color: #ebf8ff; border: 3px dashed #4299e1; color: #2c5282; padding: 30px 20px; border-radius: 15px; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .current-word { font-size: 60px; font-weight: bold; color: #2b6cb0; line-height: 1.2; margin-bottom: 5px; text-align: center; }
        .word-pronunciation { font-size: 14px; color: #fff; background: #4a5568; padding: 4px 12px; border-radius: 20px; margin-bottom: 10px; }
        .full-sentence-preview { font-size: 16px; color: #718096; text-align: center; margin-top: 15px; min-height: 24px; }

        .controls-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .control-item { flex: 1; min-width: 140px; }

        .buttons { display: flex; gap: 10px; margin-top: 20px; }
        button.main-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #btn-play { background: #48bb78; } #btn-pause { background: #ecc94b; color: #4a5568; } #btn-stop { background: #f56565; }
        .nav-btn { background: #cbd5e0; color: #4a5568; max-width: 60px; }
        button:active { transform: scale(0.98); } button:disabled { background: #edf2f7; color: #cbd5e0; cursor: not-allowed; box-shadow: none; }

        .status { margin-top: 10px; text-align: right; font-size: 13px; color: #718096; }
        
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #edf2f7; font-size: 12px; color: #a0aec0; text-align: center; line-height: 1.6; }
        .footer a { color: #718096; text-decoration: underline; }
    </style>
	<style>
		/* ç¦æ­¢é¸å–æ–‡å­— */
		body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
	</style>
	<script>
		// ç¦æ­¢å³éµé¸å–®
		document.addEventListener('contextmenu', event => event.preventDefault());
		// ç¦æ­¢ F12 å’Œä¸€äº›å¿«æ·éµ (åƒ…ä½œç°¡å–®é˜²è­·)
		document.onkeydown = function(e) {
			if(event.keyCode == 123) { return false; } // F12
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } // Ctrl+Shift+C
			if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } // Ctrl+Shift+J
			if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
		}
	</script>
</head>
<body>

<div class="nav-home">
    <a href="../../index.html" class="btn-home">â¬… å›é¦–é  (Back to Home)</a>
</div>

<div class="container">
    <h2>ğŸ“ æ™ºèƒ½èªå¢ƒé»˜æ›¸ç¥å™¨</h2>

    <div class="ad-container">
        <span>Google AdSense å»£å‘Šé¡¯ç¤ºä½ç½®</span>
    </div>

    <div class="section-box">
        <label>é»˜æ›¸å…§å®¹è¼¸å…¥ï¼š</label>
        <div class="tips">
            ğŸ’¡ <b>Live åµæ¸¬ï¼š</b> è‡ªå‹•åˆ†è¾¨ [adj] è³´-v (ç¾å ´) / [v] åŠ›-v (ä½)ã€‚ç¯„ä¾‹ï¼šLive[adj] musicã€‚<br>
        </div>
        <textarea id="text-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥è‹±æ–‡æˆ–ä¸­æ–‡å…§å®¹...">I like live[adj] music.
I live[v] in Hong Kong.</textarea>
        
        <div class="action-bar">
            <div class="action-left">
                <input id="file-upload" type="file" accept=".txt" style="display:none;"/>
                <button onclick="document.getElementById('file-upload').click()" class="btn-sm btn-upload">ğŸ“‚ ä¸Šå‚³æª”æ¡ˆ</button>
                <span id="file-name" style="font-size:12px; color:#888;"></span>
            </div>
            <button id="btn-toggle-view" class="btn-sm btn-toggle-eye">ğŸ‘ï¸ é®è”½å…§å®¹ (é»˜æ›¸æ¨¡å¼)</button>
        </div>
    </div>

    <div class="section-box">
        <div class="controls-row">
            <div class="control-item">
                <label>èªè¨€</label>
                <select id="lang-select">
                    <option value="en-GB">è‹±èª (UK/Commonwealth)</option>
                    <option value="zh-HK">ç²µèª (Cantonese)</option>
                    <option value="zh-CN">æ™®é€šè©± (Mandarin)</option>
                </select>
            </div>
            <div class="control-item">
                <label>è®€å­—èªé€Ÿ: <span id="rate-value">0.8</span>x</label>
                <input type="range" id="rate-range" min="0.1" max="1.5" step="0.1" value="0.8">
            </div>
            <div class="control-item">
                <label style="color:#3182ce;">å­—èˆ‡å­—åœé “: <span id="interval-value">1.5</span>ç§’</label>
                <input type="range" id="interval-range" min="0" max="5" step="0.5" value="1.5">
            </div>
        </div>
        <div style="margin-top:15px; display:flex; gap:20px; align-items:center;">
             <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="auto-play-check"> è‡ªå‹•è®€ä¸‹ä¸€å¥
             </label>
             <label style="font-weight:normal; cursor:pointer; display:flex; align-items:center; gap:5px;">
                 <input type="checkbox" id="dictation-mode" checked> é»˜æ›¸æ¨¡å¼ (é€å­—è®€)
             </label>
        </div>
    </div>

    <div class="dictation-display">
        <div class="word-pronunciation" id="pronunciation-display" style="display:none;"></div>
        <div class="current-word" id="current-word-display">...</div>
        <div class="full-sentence-preview" id="sentence-preview">æº–å‚™å°±ç·’</div>
    </div>
    <div style="text-align:center; color:#888; font-size:12px;" id="progress-indicator">ç¬¬ 0 / 0 å¥</div>

    <div class="buttons">
        <button id="btn-prev" class="main-btn nav-btn" disabled>â®</button>
        <button id="btn-play" class="main-btn">â–¶ é–‹å§‹</button>
        <button id="btn-pause" class="main-btn" style="display:none;">â¸ æš«åœ</button>
        <button id="btn-stop" class="main-btn" disabled>â¹ åœæ­¢</button>
        <button id="btn-next" class="main-btn nav-btn" disabled>â­</button>
    </div>
    
    <div class="status" id="status-msg"></div>

    <div class="footer">
        <p>ğŸ”’ <strong>éš±ç§æ¬Šè²æ˜ï¼š</strong> æœ¬ç³»çµ±æ‰€æœ‰æ–‡å­—è™•ç†èˆ‡é‹ç®—å‡åœ¨æ‚¨çš„ç€è¦½å™¨å…§å®Œæˆ (Client-side processing)ã€‚æˆ‘å€‘ä¸æœƒæ”¶é›†æ‚¨çš„ä»»ä½•è³‡æ–™ã€‚</p>
        <p><a href="privacy.html">æŸ¥çœ‹å®Œæ•´éš±ç§æ¬Šæ”¿ç­–</a> | Â© 2026 Playneer Kids</p>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    const textInput = document.getElementById('text-input');
    const btnToggleView = document.getElementById('btn-toggle-view');
    const langSelect = document.getElementById('lang-select');
    const rateRange = document.getElementById('rate-range');
    const rateValue = document.getElementById('rate-value');
    const intervalRange = document.getElementById('interval-range');
    const intervalValue = document.getElementById('interval-value');
    const autoPlayCheck = document.getElementById('auto-play-check');
    const dictationModeCheck = document.getElementById('dictation-mode');
    
    const currentWordDisplay = document.getElementById('current-word-display');
    const pronunciationDisplay = document.getElementById('pronunciation-display');
    const sentencePreview = document.getElementById('sentence-preview');
    const progressIndicator = document.getElementById('progress-indicator');
    const statusMsg = document.getElementById('status-msg');
    
    const btnPlay = document.getElementById('btn-play');
    const btnPause = document.getElementById('btn-pause');
    const btnStop = document.getElementById('btn-stop');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    let sentences = []; let sentenceIndex = 0; let wordQueue = []; let wordIndex = 0;
    let isPlaying = false; let isPaused = false; let timerId = null; let voices = [];
    let isMasked = false;

    function init() { populateVoices(); if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoices; }
    function populateVoices() { voices = synth.getVoices(); }
    init();

    rateRange.addEventListener('input', () => rateValue.textContent = rateRange.value);
    intervalRange.addEventListener('input', () => intervalValue.textContent = intervalRange.value);
    textInput.addEventListener('input', () => { if(!isPlaying && !isPaused) resetPlayer(); });
    
    btnToggleView.addEventListener('click', () => {
        isMasked = !isMasked;
        if (isMasked) {
            document.body.classList.add('masked-mode');
            btnToggleView.textContent = "ğŸ‘ï¸ é¡¯ç¤ºå…§å®¹"; btnToggleView.style.background = "#2b6cb0";
        } else {
            document.body.classList.remove('masked-mode');
            btnToggleView.textContent = "ğŸ‘ï¸ é®è”½å…§å®¹ (é»˜æ›¸æ¨¡å¼)"; btnToggleView.style.background = "#ed8936";
        }
    });

    document.getElementById('file-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('file-name').textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => { textInput.value = e.target.result; resetPlayer(); statusMsg.textContent = "æª”æ¡ˆå·²è¼‰å…¥"; };
        reader.readAsText(file);
    });

    function splitTextIntoSentences(text) {
        // ä¿®æ”¹èªªæ˜ï¼š
        // èˆŠé‚è¼¯ï¼šåªæŠ“æ¨™é»ç¬¦è™Ÿ -> [.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]*
        // æ–°é‚è¼¯ï¼šæŠ“æ¨™é»ç¬¦è™Ÿ + é¸æ“‡æ€§æŠ“å–å¾Œé¢çš„æ”¶å¼•è™Ÿ -> (?:[.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+[â€â€™ã€ï¼‰\]]*)?
        
        // åŒ…å«å¸¸è¦‹çš„æ”¶å°¾ç¬¦è™Ÿï¼šâ€ (å³é›™å¼•è™Ÿ), â€™ (å³å–®å¼•è™Ÿ), ã€ (ä¸­æ–‡å³å¼•è™Ÿ), ï¼‰ (å…¨å½¢å³æ‹¬è™Ÿ), ] (åŠå½¢å³æ‹¬è™Ÿ)
        const regex = /[^.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+(?:[.?!;:ã€‚ï¼Ÿï¼ï¼›ï¼š\n]+[â€â€™ã€ï¼‰\]]*)?|.+/g;
        
        return (text.match(regex) || []).map(s => s.trim()).filter(s => s.length > 0);
    }

    function generateDictationQueue(text, lang) {
        let queue = [];
        
        // 1. è‹±æ–‡è™•ç†é‚è¼¯ (ä¿æŒä¸è®Š)
        if (lang === 'en-GB') {
            const rawTokens = text.match(/[\w']+(\[[a-z]+\])?|[^\w\s]/gi) || [];
            const punctMap = { '.': 'full stop', ',': 'comma', '?': 'question mark', '!': 'exclamation mark', ':': 'colon', ';': 'semi-colon', '(': 'open bracket', ')': 'close bracket', '"': 'quote' };
            for (let i = 0; i < rawTokens.length; i++) {
                let token = rawTokens[i], cleanWord = token, speakWord = token, manualTag = null;
                if (token.includes('[')) {
                    if (token.toLowerCase().includes('[adj]')) manualTag = 'adj';
                    else if (token.toLowerCase().includes('[v]')) manualTag = 'v';
                    cleanWord = token.replace(/\[.*?\]/g, ''); speakWord = cleanWord;
                }
                if (punctMap[cleanWord]) queue.push({ display: cleanWord, speak: punctMap[cleanWord], isPunct: true });
                else {
                    if (cleanWord.toLowerCase() === 'live') {
                        if (manualTag === 'adj') speakWord = "lye-v"; else if (manualTag === 'v') speakWord = "liv"; else speakWord = detectLivePronunciation(i, rawTokens);
                    }
                    queue.push({ display: cleanWord, speak: speakWord, isPunct: false });
                }
            }
        } 
        // 2. ä¸­æ–‡è™•ç†é‚è¼¯ (é€™è£¡åŠ å…¥äº†å…’åŒ–éŸ³åˆ¤æ–·)
        else {
            //const punctMap = { 'ï¼Œ': 'é€—è™Ÿ', 'ã€‚': 'å¥è™Ÿ', 'ã€': 'é “è™Ÿ', 'ï¼Ÿ': 'å•è™Ÿ', 'ï¼': 'æ„Ÿå˜†è™Ÿ', 'ï¼š': 'å†’è™Ÿ', 'ï¼›': 'åˆ†è™Ÿ', 'ã€Œ': 'é–‹å¼•è™Ÿ', 'ã€': 'æ”¶å¼•è™Ÿ', 'ï¼ˆ': 'æ‹¬è™Ÿ', 'ï¼‰': 'æ‹¬è™Ÿå®Œ', ',': 'é€—è™Ÿ', '.': 'å¥è™Ÿ', '?': 'å•è™Ÿ', '!': 'æ„Ÿå˜†è™Ÿ' };
            const punctMap = { 'ï¼Œ': 'é€—è™Ÿ', 'ã€‚': 'å¥è™Ÿ', 'ã€': 'é “è™Ÿ', 'ï¼Ÿ': 'å•è™Ÿ', 'ï¼': 'æ„Ÿå˜†è™Ÿ', 'ï¼š': 'å†’è™Ÿ', 'ï¼›': 'åˆ†è™Ÿ', 'ã€Œ': 'é–‹å¼•è™Ÿ', 'ã€': 'é—œå¼•è™Ÿ', 'ï¼ˆ': 'é–‹æ‹¬è™Ÿ', 'ï¼‰': 'é—œæ‹¬è™Ÿ', ',': 'é€—è™Ÿ', '.': 'å¥è™Ÿ', '?': 'å•è™Ÿ', '!': 'æ„Ÿå˜†è™Ÿ' };

            // æ”¹ç”¨ for è¿´åœˆï¼Œä»¥ä¾¿æ§åˆ¶ç´¢å¼• (i)
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                let nextChar = text[i+1]; // å·çœ‹ä¸‹ä¸€å€‹å­—

                // è·³éç‰¹æ®Šçš„æ¨™è¨˜ç¬¦è™Ÿ (ä¿æŒåŸé‚è¼¯)
                if (['[', ']', 'a', 'd', 'j', 'v'].includes(char) && text.includes('[')) continue; 
                if (char.trim() === '') continue;

                // è™•ç†æ¨™é»ç¬¦è™Ÿ
                if (punctMap[char]) {
                    queue.push({ display: char, speak: punctMap[char], isPunct: true });
                }
                // --- âœ¨ æ–°å¢ï¼šå…’åŒ–éŸ³è™•ç†é‚è¼¯ âœ¨ ---
                // å¦‚æœç›®å‰ä¸æ˜¯æ¨™é»ï¼Œä¸”ä¸‹ä¸€å€‹å­—æ˜¯ã€Œå…’ã€ï¼Œä¸”èªè¨€æ˜¯æ™®é€šè©±(zh-CN)
                else if (nextChar === 'å…’' && lang === 'zh-CN' && !punctMap[nextChar]) {
                    // æŠŠ "é€™" å’Œ "å…’" åˆä½µæˆ "é€™å…’"
                    let combined = char + nextChar;
                    queue.push({ display: combined, speak: combined, isPunct: false });
                    i++; // é‡è¦ï¼å› ç‚ºå·²ç¶“æŠŠã€Œå…’ã€ç”¨æ‰äº†ï¼Œæ‰€ä»¥è·³éä¸‹ä¸€æ¬¡è¿´åœˆ
                }
                // ----------------------------------
                else if (char === 'ç©' && lang === 'zh-HK') {
                    queue.push({ display: 'ç©', speak: 'æ›', isPunct: false });
                }
                else {
                    queue.push({ display: char, speak: char, isPunct: false });
                }
            }
        }
        return queue;
    }
	
    function detectLivePronunciation(idx, tokens) {
        let pronunciation = "liv"; 
        const clean = (t) => t ? t.replace(/\[.*?\]/g, '').toLowerCase() : '';
        const prev = idx > 0 ? clean(tokens[idx - 1]) : '';
        const next = idx < tokens.length - 1 ? clean(tokens[idx + 1]) : '';
        const adjK = ['music', 'show', 'band', 'stream', 'broadcast', 'concert', 'performance', 'video', 'radio', 'tv', 'action'];
        if (adjK.includes(next) || prev === 'real' || ['facebook', 'youtube', 'instagram'].includes(prev)) return "lye-v";
        if (['in', 'at', 'on', 'with', 'by'].includes(next) || ['i', 'we', 'you', 'they'].includes(prev)) return "liv";
        return pronunciation; 
    }

    function startSentence() {
        if (sentenceIndex >= sentences.length) { statusMsg.textContent = "å…¨éƒ¨å®Œæˆ"; resetPlayer(); return; }
        const raw = sentences[sentenceIndex];
        const lang = langSelect.value;
        sentencePreview.textContent = raw.replace(/\[.*?\]/g, '');
        progressIndicator.textContent = `ç¬¬ ${sentenceIndex + 1} / ${sentences.length} å¥`;
        wordQueue = generateDictationQueue(raw, lang);
        wordIndex = 0;
        if (dictationModeCheck.checked) playNextWord();
        else { let fullSpeak = wordQueue.map(w => w.speak).join(' '); playWholeSentence(fullSpeak, sentencePreview.textContent); }
    }

    function playNextWord() {
        if (!isPlaying) return;
        if (wordIndex >= wordQueue.length) { finishSentence(); return; }
        const item = wordQueue[wordIndex];
        currentWordDisplay.textContent = item.display;
        
        if (item.isPunct) { pronunciationDisplay.textContent = `è®€ä½œ: ${item.speak}`; pronunciationDisplay.style.display = 'block'; } 
        else if (item.display.toLowerCase() === 'live' && item.speak === 'lye-v') { pronunciationDisplay.textContent = `ç™¼éŸ³: è³´-v (å½¢å®¹è©)`; pronunciationDisplay.style.display = 'block'; } 
        else { pronunciationDisplay.style.display = 'none'; }

        const u = new SpeechSynthesisUtterance(item.speak);
        setupVoice(u);
        u.onend = () => { if (!isPlaying) return; statusMsg.textContent = `åœé “...`; timerId = setTimeout(() => { wordIndex++; playNextWord(); }, parseFloat(intervalRange.value) * 1000); };
        u.onerror = () => { wordIndex++; playNextWord(); }; 
        statusMsg.textContent = "ğŸ”Š æœ—è®€ä¸­";
        synth.speak(u);
    }

    function playWholeSentence(speakText, displayText) {
        currentWordDisplay.textContent = displayText; currentWordDisplay.style.fontSize = "24px"; pronunciationDisplay.style.display = 'none';
        const u = new SpeechSynthesisUtterance(speakText); setupVoice(u);
        u.onend = () => finishSentence(); synth.speak(u);
    }

    function finishSentence() {
        if (autoPlayCheck.checked && isPlaying) { statusMsg.textContent = "æº–å‚™ä¸‹ä¸€å¥..."; currentWordDisplay.style.fontSize = "60px"; timerId = setTimeout(() => { sentenceIndex++; startSentence(); }, 1000); } 
        else { isPlaying = false; wordIndex = 0; statusMsg.textContent = "æœ¬å¥çµæŸ"; currentWordDisplay.style.fontSize = "60px"; updateUI(); }
    }

    function setupVoice(u) {
        u.lang = langSelect.value; u.rate = parseFloat(rateRange.value);
        let v = voices.find(v => v.lang === u.lang) || voices.find(v => v.lang.startsWith(u.lang.split('-')[0]));
        if (u.lang === 'en-GB') v = voices.find(v => v.lang === 'en-GB' && v.name.includes('Google')) || voices.find(v => v.lang === 'en-GB');
        if (v) u.voice = v;
    }

    btnPlay.addEventListener('click', () => {
        if (sentences.length === 0) { const txt = textInput.value.trim(); if (!txt) { alert("è«‹è¼¸å…¥æ–‡å­—"); return; } sentences = splitTextIntoSentences(txt); }
        isPlaying = true; isPaused = false;
        if (wordIndex === 0 && sentenceIndex < sentences.length) startSentence(); else if (wordQueue.length > 0) playNextWord(); else startSentence();
        updateUI();
    });

    btnPause.addEventListener('click', () => { isPlaying = false; isPaused = true; synth.cancel(); clearTimeout(timerId); statusMsg.textContent = "å·²æš«åœ"; updateUI(); });
    btnStop.addEventListener('click', resetPlayer);
    btnPrev.addEventListener('click', () => { if(sentenceIndex>0){ sentenceIndex--; resetForNavigation();} });
    btnNext.addEventListener('click', () => { if(sentenceIndex<sentences.length-1){ sentenceIndex++; resetForNavigation();} });
    
    function resetForNavigation() { isPlaying=false; isPaused=false; synth.cancel(); clearTimeout(timerId); wordIndex=0; wordQueue=[]; 
        sentencePreview.textContent = sentences[sentenceIndex].replace(/\[.*?\]/g, ''); currentWordDisplay.textContent = "..."; progressIndicator.textContent = `ç¬¬ ${sentenceIndex + 1} / ${sentences.length} å¥`; updateUI(); }
    
    function resetPlayer() { isPlaying=false; isPaused=false; synth.cancel(); clearTimeout(timerId); sentenceIndex=0; wordIndex=0; wordQueue=[]; sentences=[]; currentWordDisplay.textContent="..."; sentencePreview.textContent="æº–å‚™å°±ç·’"; progressIndicator.textContent="ç¬¬ 0 / 0 å¥"; statusMsg.textContent="å·²é‡ç½®"; updateUI(); }

    function updateUI() {
        if (isPlaying) { btnPlay.style.display = 'none'; btnPause.style.display = 'inline-block'; btnStop.disabled = false; textInput.disabled = true; dictationModeCheck.disabled = true; } 
        else { btnPlay.textContent = (isPaused) ? "â–¶ ç¹¼çºŒ" : ((sentences.length > 0 && wordIndex === 0) ? "â–¶ æœ—è®€æ­¤å¥" : "â–¶ é–‹å§‹"); btnPlay.style.display = 'inline-block'; btnPause.style.display = 'none'; btnStop.disabled = !(sentences.length > 0 || textInput.value.trim().length > 0); if (sentences.length > 0) { btnPrev.disabled = (sentenceIndex===0); btnNext.disabled = (sentenceIndex>=sentences.length-1); } else { btnPrev.disabled=true; btnNext.disabled=true; } textInput.disabled = false; dictationModeCheck.disabled = false; }
    }
</script>

</body>
</html>